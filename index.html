<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>許願池</title>
<style>
/* 
==========================================================================
侘寂美學 (Wabi-Sabi) 核心 CSS (已精簡)
設計理念：擁抱不完美、自然、與寧靜。
==========================================================================
*/

:root {
--wabi-sabi-bg: #f4f2ef; /* 柔和的米白，如同宣紙 */
--wabi-sabi-text: #5a5a5a; /* 深灰，如同石頭的陰影 */
--wabi-sabi-border: #d3d1cc; /* 淺灰，如同風化的木材 */
--wabi-sabi-accent: #a9a299; /* 暖灰，如同乾燥的苔蘚 */
--wabi-sabi-highlight: #ffffff; /* 高光白，如同清晨的薄霧 */
--wabi-sabi-error: #c98a8a; /* 錯誤色 */

--animation-duration-slow: 2s;
--animation-duration-medium: 0.8s;
--animation-duration-fast: 0.4s;

--border-radius-small: 4px;
--border-radius-medium: 8px;
--border-radius-full: 50px;
}

/* 
==========================================================================
基本重置與全域設定
==========================================================================
*/
*,
*::before,
*::after {
box-sizing: border-box;
margin: 0;
padding: 0;
}

html, body {
height: 100%;
width: 100%;
overflow: hidden;
}

body {
font-family: 'Noto Sans TC', 'Helvetica Neue', Helvetica, Arial, sans-serif;
background-color: var(--wabi-sabi-bg);
color: var(--wabi-sabi-text);
display: flex;
justify-content: center;
align-items: center;
transition: background-color var(--animation-duration-medium) ease-in-out;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

/* 
==========================================================================
主容器與佈局
==========================================================================
*/
.container {
width: 90%;
max-width: 680px;
text-align: center;
opacity: 0;
transform: translateY(20px);
animation: fadeIn var(--animation-duration-medium) ease-out forwards;
animation-delay: 0.5s;
}

@keyframes fadeIn {
to {
opacity: 1;
transform: translateY(0);
}
}

/* 
==========================================================================
許願輸入框
==========================================================================
*/
.wish-input-wrapper {
position: relative;
margin-bottom: 3rem;
}

.wish-input {
width: 100%;
background: transparent;
border: none;
border-bottom: 1px solid var(--wabi-sabi-border);
padding: 15px 10px;
font-size: 1.8rem;
color: var(--wabi-sabi-text);
text-align: center;
outline: none;
transition: border-color var(--animation-duration-fast) ease-in-out, box-shadow var(--animation-duration-fast) ease-in-out;
font-weight: 300;
letter-spacing: 0.1em;
}

.wish-input::placeholder {
color: var(--wabi-sabi-border);
font-style: italic;
transition: color var(--animation-duration-fast) ease;
}

.wish-input:focus {
border-color: var(--wabi-sabi-accent);
box-shadow: 0 5px 25px -10px rgba(0,0,0,0.05);
}

.wish-input:focus::placeholder {
color: transparent;
}

/* 
==========================================================================
實現按鈕
==========================================================================
*/
.wish-button {
position: relative;
background-color: transparent;
border: 1px solid var(--wabi-sabi-border);
color: var(--wabi-sabi-accent);
padding: 18px 40px;
font-size: 1.2rem;
cursor: pointer;
border-radius: var(--border-radius-full);
outline: none;
overflow: hidden;
transition: all var(--animation-duration-fast) cubic-bezier(0.25, 0.8, 0.25, 1);
letter-spacing: 0.2em;
text-transform: uppercase;
}

.wish-button:hover {
background-color: var(--wabi-sabi-highlight);
border-color: var(--wabi-sabi-accent);
color: var(--wabi-sabi-text);
box-shadow: 0 10px 30px -15px rgba(0,0,0,0.1);
transform: translateY(-3px);
}

.wish-button:active {
transform: translateY(0);
box-shadow: none;
}

.wish-button.secondary {
background-color: transparent;
color: var(--wabi-sabi-accent);
border-color: var(--wabi-sabi-border);
}

.wish-button.secondary:hover {
background-color: var(--wabi-sabi-bg);
border-color: var(--wabi-sabi-accent);
color: var(--wabi-sabi-text);
}

.ripple {
position: absolute;
border-radius: 50%;
background-color: rgba(169, 162, 153, 0.3);
transform: scale(0);
animation: ripple-effect var(--animation-duration-medium) linear;
}

@keyframes ripple-effect {
to {
transform: scale(4);
opacity: 0;
}
}

/* 
==========================================================================
加載動畫 (已加入進度顯示)
==========================================================================
*/
.loader {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(244, 242, 239, 0.8);
backdrop-filter: blur(5px);
z-index: 9999;
opacity: 0;
transition: opacity var(--animation-duration-fast) ease;
}

.loader.active {
display: flex;
justify-content: center;
align-items: center;
opacity: 1;
}

.loader-content {
display: flex;
flex-direction: column;
align-items: center;
gap: 24px;
}

.loader-text {
font-size: 0.9rem;
color: var(--wabi-sabi-accent);
letter-spacing: 0.1em;
text-transform: uppercase;
}

.progress-bar-container {
width: 150px;
height: 2px;
background-color: var(--wabi-sabi-border);
border-radius: 2px;
overflow: hidden;
}

.progress-bar {
width: 100%;
height: 100%;
background-color: var(--wabi-sabi-accent);
transform: translateX(-100%);
animation: progress-animation 2.5s ease-in-out infinite;
}

@keyframes progress-animation {
0% { transform: translateX(-100%); }
50% { transform: translateX(0%); }
100% { transform: translateX(100%); }
}

.particle-container {
position: relative;
width: 100px;
height: 100px;
}

.particle {
position: absolute;
top: 50%;
left: 50%;
width: 6px;
height: 6px;
background: var(--wabi-sabi-accent);
border-radius: 50%;
animation: orbit var(--animation-duration-slow) linear infinite;
}

.particle:nth-child(2) { animation-delay: -0.2s; }
.particle:nth-child(3) { animation-delay: -0.4s; }
.particle:nth-child(4) { animation-delay: -0.6s; }
.particle:nth-child(5) { animation-delay: -0.8s; }
.particle:nth-child(6) { animation-delay: -1.0s; }
.particle:nth-child(7) { animation-delay: -1.2s; }
.particle:nth-child(8) { animation-delay: -1.4s; }
.particle:nth-child(9) { animation-delay: -1.6s; }
.particle:nth-child(10) { animation-delay: -1.8s; }

@keyframes orbit {
0% { transform: translate(-50%, -50%) rotate(0deg) translateX(50px) scale(1); opacity: 1; }
50% { transform: translate(-50%, -50%) rotate(180deg) translateX(50px) scale(0.5); opacity: 0.5; }
100% { transform: translate(-50%, -50%) rotate(360deg) translateX(50px) scale(1); opacity: 1; }
}

/* 
==========================================================================
結果顯示區域
==========================================================================
*/
#result-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: var(--wabi-sabi-bg);
z-index: 1000;
transform: translateY(100%);
transition: transform var(--animation-duration-medium) cubic-bezier(0.77, 0, 0.175, 1);
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
padding: 20px;
}

#result-container.visible {
transform: translateY(0);
}

.result-content-wrapper {
width: 100%;
height: 100%;
max-width: 1200px;
max-height: 90vh;
display: flex;
flex-direction: column;
background: var(--wabi-sabi-highlight);
border: 1px solid var(--wabi-sabi-border);
border-radius: var(--border-radius-medium);
box-shadow: 0 10px 30px -15px rgba(0,0,0,0.1);
opacity: 0;
transform: scale(0.95);
transition: all var(--animation-duration-fast) ease-in-out;
}

#result-container.visible .result-content-wrapper {
opacity: 1;
transform: scale(1);
transition-delay: 0.2s;
}

.result-header {
display: flex;
justify-content: flex-end;
padding: 8px;
border-bottom: 1px solid var(--wabi-sabi-border);
gap: 8px;
}

.result-control-button {
width: 36px;
height: 36px;
background: transparent;
border: 1px solid var(--wabi-sabi-border);
border-radius: 50%;
cursor: pointer;
z-index: 1001;
opacity: 0;
visibility: hidden;
transition: all var(--animation-duration-fast) ease;
display: flex;
justify-content: center;
align-items: center;
color: var(--wabi-sabi-text);
}

#result-container.visible .result-control-button {
opacity: 1;
visibility: visible;
transition-delay: 0.4s;
}

.result-control-button:hover {
background-color: var(--wabi-sabi-bg);
border-color: var(--wabi-sabi-accent);
}

.result-control-button svg {
width: 18px;
height: 18px;
stroke: var(--wabi-sabi-text);
}

#close-button:hover {
transform: rotate(90deg);
}

.close-button::before,
.close-button::after {
content: '';
position: absolute;
width: 18px;
height: 1px;
background-color: currentColor;
}

.close-button::before {
transform: rotate(45deg);
}

.close-button::after {
transform: rotate(-45deg);
}

#tool-output {
flex-grow: 1;
overflow: hidden;
border-radius: 0 0 var(--border-radius-medium) var(--border-radius-medium);
}

/* 
==========================================================================
錯誤訊息提示
==========================================================================
*/
.error-message {
color: var(--wabi-sabi-error);
margin-top: 15px;
opacity: 0;
height: 0;
transition: opacity var(--animation-duration-fast) ease, height var(--animation-duration-fast) ease;
font-style: italic;
overflow: hidden;
}

.error-message.visible {
opacity: 1;
height: auto; /* 自動高度 */
min-height: 20px;
}

/* 
==========================================================================
修訂介面 (Revision Interface)
==========================================================================
*/
.revision-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(244, 242, 239, 0.8);
backdrop-filter: blur(5px);
z-index: 10000;
display: flex;
justify-content: center;
align-items: center;
opacity: 0;
visibility: hidden;
transition: opacity var(--animation-duration-fast) ease, visibility 0s var(--animation-duration-fast);
}

.revision-overlay.visible {
opacity: 1;
visibility: visible;
transition: opacity var(--animation-duration-fast) ease, visibility 0s;
}

.revision-modal {
width: 90%;
max-width: 500px;
text-align: center;
transform: scale(0.95);
transition: transform var(--animation-duration-fast) ease;
}

.revision-overlay.visible .revision-modal {
transform: scale(1);
}

.revision-modal .wish-input {
font-size: 1.5rem;
margin-bottom: 2rem;
}

.revision-actions {
display: flex;
gap: 1rem;
justify-content: center;
}

/* 
==========================================================================
背景裝飾性元素
==========================================================================
*/
body::before {
content: '';
position: fixed;
top: -50%;
left: -50%;
width: 200%;
height: 200%;
background-image: radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 60%);
animation: subtleShine 20s ease-in-out infinite;
z-index: -1;
}

@keyframes subtleShine {
0%, 100% { transform: translate(0, 0); }
25% { transform: translate(10px, 20px); }
50% { transform: translate(-10px, -15px); }
75% { transform: translate(5px, -20px); }
}

.decorative-grain {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
pointer-events: none;
/* [錯誤修復]：修正了此處的 Base64 編碼，解決 net::ERR_INVALID_URL 錯誤。*/
background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuOCIgbnVtT2N0YXZlcz0iMyIgc3RpdGNoVGlsZXM9InN0aXRjaCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWx0ZXI9InVybCgjbm9pc2UpIiBvcGFjaXR5PSIwLjAyIi8+PC9zdmc+');
z-index: -2;
opacity: 0.5;
}

/* 
==========================================================================
響應式設計
==========================================================================
*/
@media (max-width: 768px) {
.wish-input {
font-size: 1.5rem;
}
.wish-button {
font-size: 1rem;
padding: 15px 30px;
}
#result-container {
padding: 10px;
}
.result-content-wrapper {
max-height: 95vh;
}
}

@media (max-width: 480px) {
.wish-input {
font-size: 1.2rem;
}
.wish-button {
width: 100%;
}
#result-container {
padding: 0;
}
.result-content-wrapper {
border-radius: 0;
height: 100%;
max-height: 100%;
}
.result-header {
padding: 4px;
gap: 4px;
}
.result-control-button {
width: 32px;
height: 32px;
}
.revision-actions {
flex-direction: column;
}
}
</style>
</head>
<body>

<div class="decorative-grain"></div>

<div class="container" id="main-interface">
<div class="wish-input-wrapper">
<input type="text" id="wish-input" class="wish-input" placeholder="你想要甚麼工具？">
</div>
<button id="wish-button" class="wish-button">實現</button>
<div id="error-message" class="error-message"></div>
</div>

<div class="loader" id="loader">
<div class="loader-content">
<div class="particle-container">
<div class="particle"></div><div class="particle"></div>
<div class="particle"></div><div class="particle"></div>
<div class="particle"></div><div class="particle"></div>
<div class="particle"></div><div class="particle"></div>
<div class="particle"></div><div class="particle"></div>
</div>
<div class="progress-bar-container">
<div class="progress-bar"></div>
</div>
<span class="loader-text">正在為你度身訂製...</span>
</div>
</div>

<div id="result-container">
<div class="result-content-wrapper">
<div class="result-header">
<button id="download-button" class="result-control-button" title="下載 HTML">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
</svg>
</button>
  <button id="revise-button" class="result-control-button" title="修訂願望">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                   </svg>
               </button><button id="close-button" class="result-control-button close-button" title="關閉"></button>
</div>
<div id="tool-output"></div>
</div>
</div>

<div id="revision-overlay" class="revision-overlay">
<div class="revision-modal">
<input type="text" id="revision-input" class="wish-input" placeholder="描述你的修訂...">
<div class="revision-actions">
<button id="submit-revision-button" class="wish-button">優化修訂</button>
<button id="cancel-revision-button" class="wish-button secondary">取消</button>
</div>
</div>
</div>

<script>
// ==========================================================================
// 侘寂風格許願工具核心 JavaScript
// 作者：世界頂尖的編程師 (智能 Prompt 優化修訂版 v2.1)
// 功能：捕捉願望，先呼叫AI優化成具體指令，再呼叫AI根據該指令生成工具。
// v2 更新：在修訂時傳入完整HTML上下文，強制AI保留原有設計。
// v2.1 更新：修復了 API 變數引用錯誤和 CSS SVG 編碼錯誤。
// ==========================================================================

document.addEventListener('DOMContentLoaded', () => {

// --- 元素節點獲取 ---
const wishInput = document.getElementById('wish-input');
const wishButton = document.getElementById('wish-button');
const loader = document.getElementById('loader');
const loaderText = document.querySelector('.loader-text');
const mainInterface = document.getElementById('main-interface');
const resultContainer = document.getElementById('result-container');
const toolOutput = document.getElementById('tool-output');
const closeButton = document.getElementById('close-button');
const downloadButton = document.getElementById('download-button');
const errorMessage = document.getElementById('error-message');
const reviseButton = document.getElementById('revise-button');
const revisionOverlay = document.getElementById('revision-overlay');
const revisionInput = document.getElementById('revision-input');
const submitRevisionButton = document.getElementById('submit-revision-button');
const cancelRevisionButton = document.getElementById('cancel-revision-button');

// --- 狀態變數 ---
let currentGeneratedHtml = '';
let originalUserWish = '';

 // --- API 配置 ---
const API_KEYS = ["sk-p-9-aIT4kSvvL_l4HEAReA"];
let currentApiKeyIndex = 0;
const API_URL = "https://chatapi.akash.network/api/v1/chat/completions";
const MODEL = "Qwen3-235B-A22B-Instruct-2507-FP8";

// ==========================================================================
// Prompt 工程：指令生成器
// ==========================================================================

/**
 * [AI調用第一步] 創建一個用於 "優化使用者願望" 的 Prompt
 */
const createWishOptimizationPrompt = (userWish) => {
return `
[SYSTEM ROLE: EXPERT PROMPT ENGINEER FOR WEB DEVELOPMENT]
你的任務是將使用者模糊的想法，轉化為一個給「網頁生成AI」的、極度清晰、具體、包含所有細節的指令 (Prompt)。

**使用者的初步想法:** "${userWish}"

**你的執行步驟:**
1.  **概念解析:** 分析 "${userWish}" 的核心功能是什麼？
2.  **功能擴展:** 腦力激盪出所有必要和加分的功能。
3.  **UI/UX設計:** 描述介面佈局、視覺回饋等。
4.  **互動邏輯:** 詳細說明JavaScript需要處理的邏輯。
5.  **整合為最終指令:** 將以上所有分析，整合成一個對「網頁生成AI」的最終指令文本。

**輸出要求:**
你的回答**只能是**你撰寫好的那個最終指令文本，不要包含任何前言、解釋或額外對話。

現在，請為這個使用者想法生成最終指令: "${userWish}"
`;
};

/**
 * [AI調用第二步] 創建用於 "生成最終HTML工具" 的超級指令
 */
const getSuperPrompt = (optimizedWish) => {
return `
[SYSTEM ROLE: ULTIMATE WEB APPLICATION GENERATOR]
你是一個由多位專家組成的「數位煉金工房」，目標是將一個極其詳細的產品需求，轉化為一個功能完善、代碼優雅的獨立HTML網頁。

**[已優化的詳細產品需求]**
${optimizedWish}

[執行流程與輸出規範]
你必須嚴格遵循詳細產品需求來進行開發。
*   **HTML 結構:** 必須使用語意化標籤。
*   **CSS 樣式:** 所有 CSS 必須封裝在 \`<style>\` 標籤內，使用 CSS 變數，並實現完美的響應式設計。
*   **JavaScript 邏輯:** 所有 JS 代碼必須封裝在 \`<script>\` 標籤內，無外部依賴，代碼模組化並有註釋。
*   **[語言強制規定 - 最高優先級]:** 生成的工具介面文字，若包含中文，**必須強制使用【繁體中文 (zh-Hant)】**。
*   **[API嵌入強制規定]:** 如果需求是實現一個需要大型語言模型（LLM）的AI工具，你必須在生成的 JavaScript 代碼中硬編碼包含以下 API 配置：
    \`\`\`javascript
    const apiKey = 'csk-mymr9kekk3t8vn3dmxf6em9jjkhcentdr3h9tj88r3xfpvfe';
    const model = 'qwen-3-235b-a22b-instruct-2507';
    const apiUrl = 'https://api.cerebras.ai/v1/chat/completions';
    \`\`\`

[最終輸出要求]
*   **格式:** 你的回答**必須且只能是**一個完整的、單一的 HTML 檔案的原始碼。
*   **內容:** 必須以 \`<!DOCTYPE html>\` 開頭，以 \`</html>\` 結尾。
*   **絕對禁止:** 你的回答中**絕對不能包含**除了代碼以外的任何解釋、開場白、結束語或Markdown標記。

現在，請根據上述詳細需求，生成這個完美的、獨立的 HTML 應用程式。
`;
};

/**
 * [AI調用第一步 - 修訂流程] 創建一個用於 "優化修訂請求" 的 Prompt
 */
const createRevisionOptimizationPrompt = (originalWish, revisionRequest) => {
    return `
[SYSTEM ROLE: EXPERT PROMPT ENGINEER FOR WEB DEVELOPMENT REVISIONS]
你的任務是將使用者的一個修訂請求，轉化為一個給「網頁修改AI」的、精準、可執行的指令集。

**背景資訊:**
*   **原始工具:** 一個基於 "${originalWish}" 想法創建的HTML應用。
*   **使用者的新修訂請求:** "${revisionRequest}"

**你的執行步驟:**
1.  **請求分析:** 理解使用者想改變、增加或移除什麼。
2.  **定位目標:** 指出需要修改的代碼區域（HTML、CSS、JS）。
3.  **制定具體指令:** 將使用者模糊的請求轉為開發者級別的具體指令。
4.  **整合為最終指令:** 將這些指令整合成一個簡潔的、給「網頁修改AI」的最終修訂指令。

**【重要】輸出指令時，應假設AI會盡力保留現有的視覺設計（顏色、字體、佈局），除非用戶的請求明確要求修改設計。你的指令應聚焦於功能和結構的變更。**

**輸出要求:**
你的回答**只能是**你撰寫好的那個最終修訂指令文本，不要包含任何前言、解釋或額外對話。

現在，請生成最終的修訂指令。
`;
};

/**
 * [AI調用第二步 - 修訂流程] 創建用於 "執行修訂" 的超級指令
 * =========================================================================
 * == ✨✨✨ 關鍵修改點 ✨✨✨ ==
 * 這個Prompt現在接收 \`existingHtml\` 作為最重要的上下文。
 * 它用極其嚴格的規則，命令AI必須保留現有設計，只進行外科手術式的修改。
 * =========================================================================
 */
const getRevisionPrompt = (existingHtml, optimizedRevisionRequest) => {
return `
[SYSTEM ROLE: EXPERT WEB APPLICATION REFINER & CODE SURGEON]
你是一個精準的代碼修改專家。你的任務是接收一個完整的HTML文件和一個具體的修改指令，然後只修改必要的部分，並返回修改後的完整HTML文件。

[EXISTING HTML CODE TO MODIFY]
這是你需要修改的完整代碼：
\`\`\`html
${existingHtml}
\`\`\`

[USER'S PRECISE REVISION INSTRUCTION]
這是你需要執行的具體修改任務：
"${optimizedRevisionRequest}"

[CRITICAL RULES - MUST BE FOLLOWED]
1.  **✨ PRESERVE DESIGN AT ALL COSTS ✨:** 這是最高優先級指令。你**絕對必須**保留原始代碼中的視覺設計、顏色方案（特別是CSS變量）、字體、佈局、間距和整體CSS風格。**除非**修訂指令中**明確**要求更改顏色或設計，否則絕對禁止改動它們。
2.  **SURGICAL MODIFICATION:** 你的目標是修改**最少量**的代碼來完成任務。不要重寫整個部分，而是在現有代碼上進行增、刪、改。就像一個外科醫生，精準地操作，而不是替換整個器官。
3.  **MAINTAIN STRUCTURE:** 保持原有的HTML、CSS和JavaScript的組織結構。
4.  **SINGLE FILE OUTPUT:** 最終的輸出必須是修改後的、完整的、單一的HTML文件。
5.  **LANGUAGE:** 所有用戶介面的文字必須保持或更新為 **繁體中文 (zh-Hant)**。

[FINAL OUTPUT REQUIREMENT]
*   你的整個回答**必須且只能是**修改後全新的、完整的HTML原始碼。
*   不要包含任何解釋、對話或Markdown標記。
*   必須以 \`<!DOCTYPE html>\` 開頭，以 \`</html>\` 結尾。

現在，請對上面提供的 [EXISTING HTML CODE TO MODIFY] 執行 [USER'S PRECISE REVISION INSTRUCTION]，並嚴格遵守所有 [CRITICAL RULES]。
`;
};


// --- 事件監聽器 ---

wishButton.addEventListener('click', handleWishSubmission);
wishInput.addEventListener('keydown', (event) => {
if (event.key === 'Enter') {
event.preventDefault();
handleWishSubmission();
}
});
closeButton.addEventListener('click', closeResult);
downloadButton.addEventListener('click', handleHtmlDownload);
reviseButton.addEventListener('click', showRevisionModal);
cancelRevisionButton.addEventListener('click', hideRevisionModal);
submitRevisionButton.addEventListener('click', handleRevisionSubmission);
revisionInput.addEventListener('keydown', (event) => {
if (event.key === 'Enter') {
handleRevisionSubmission();
}
});

// --- 核心處理函數 ---
async function handleWishSubmission() {
    const userWish = wishInput.value.trim();
    if (!userWish) {
        showError('願望不能為空。');
        return;
    }

    originalUserWish = userWish;
    hideError();
    showLoader(true);

    try {
        const optimizationPrompt = createWishOptimizationPrompt(userWish);
        const optimizedWish = await fetchAIResponse(optimizationPrompt);
        console.groupCollapsed("【開發者資訊】第一次AI調用：優化後的生成Prompt");
        console.log(optimizedWish);
        console.groupEnd();

        loaderText.textContent = '正在實現願望...';
        const superPrompt = getSuperPrompt(optimizedWish);
        const rawHtmlResponse = await fetchAIResponse(superPrompt);
        const generatedContent = cleanAIResponse(rawHtmlResponse);

        if (!generatedContent) {
            throw new Error('AI未能生成有效的HTML程式碼。請檢查F12控制台中的優化Prompt是否合理。');
        }

        currentGeneratedHtml = generatedContent;
        displayResult(currentGeneratedHtml);

    } catch (error) {
        console.error('實現願望時發生錯誤:', error);
        showError(`抱歉，實現願望時遇到阻礙: ${error.message}`);
        hideLoader();
    }
}

async function handleRevisionSubmission() {
    const revisionRequest = revisionInput.value.trim();
    if (!revisionRequest) {
        revisionInput.style.borderColor = 'var(--wabi-sabi-error)';
        setTimeout(() => { revisionInput.style.borderColor = ''; }, 2000);
        return;
    }

    hideRevisionModal();
    showLoader(false);

    try {
        const revisionOptimizationPrompt = createRevisionOptimizationPrompt(originalUserWish, revisionRequest);
        const optimizedRevision = await fetchAIResponse(revisionOptimizationPrompt);
        console.groupCollapsed("【開發者資訊】第一次AI調用：優化後的修訂Prompt");
        console.log(optimizedRevision);
        console.groupEnd();

        loaderText.textContent = '正在應用修訂...';
        
        // =========================================================================
        // == ✨✨✨ 關鍵修改點 ✨✨✨ ==
        // 此處傳入 `currentGeneratedHtml` 而非 `originalUserWish`。
        // 這為AI提供了完整的、需要被修改的代碼上下文。
        // =========================================================================
        const revisionPrompt = getRevisionPrompt(currentGeneratedHtml, optimizedRevision);
        const rawHtmlResponse = await fetchAIResponse(revisionPrompt);
        const generatedContent = cleanAIResponse(rawHtmlResponse);

        if (!generatedContent) {
            throw new Error('AI未能生成有效的HTML修訂程式碼。請檢查F12控制台中的優化Prompt是否合理。');
        }
        
        currentGeneratedHtml = generatedContent;
        updateResultDisplay(currentGeneratedHtml);
        
        originalUserWish = `(Originally: ${originalUserWish}) - Then revised to incorporate: ${revisionRequest}`;

    } catch (error) {
        console.error('修訂願望時發生錯誤:', error);
        alert(`修訂失敗: ${error.message}`);
        hideLoader();
    }
}

async function fetchAIResponse(prompt) {
    // [錯誤修復]：修正了 API 相關變數的引用，使其與頂部定義的常數一致。
    const apiKey = API_KEYS[currentApiKeyIndex];
    
    const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
            model: MODEL,
            messages: [{ role: 'user', content: prompt }],
            max_tokens: 64000,
            temperature: 0.3
        })
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error?.message || `HTTP 錯誤! 狀態: ${response.status}`);
    }

    const data = await response.json();
    const content = data.choices?.[0]?.message?.content;

    if (!content) {
        throw new Error('AI返回的數據格式不正確或為空。');
    }
    return content;
}

function handleHtmlDownload() {
    if (!currentGeneratedHtml) {
        alert('沒有可下載的內容。');
        return;
    }
    const blob = new Blob([currentGeneratedHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'wish-tool.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// --- UI 控制函數 ---

function showLoader(isInitial) {
    loaderText.textContent = isInitial ? '正在為你實現願望...' : '正在準備修訂...';
    loader.classList.add('active');
    if (!resultContainer.classList.contains('visible')) {
        mainInterface.style.transition = 'opacity 0.5s ease, filter 0.5s ease';
        mainInterface.style.opacity = '0.5';
        mainInterface.style.filter = 'blur(3px)';
    }
}

function hideLoader() {
    loader.classList.remove('active');
    if (!resultContainer.classList.contains('visible')) {
        mainInterface.style.opacity = '1';
        mainInterface.style.filter = 'none';
    }
}

function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.add('visible');
    wishInput.style.borderColor = 'var(--wabi-sabi-error)';
}

function hideError() {
    errorMessage.classList.remove('visible');
    wishInput.style.borderColor = '';
}

function updateResultDisplay(htmlContent) {
    toolOutput.innerHTML = ''; 
    const iframe = document.createElement('iframe');
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups');
    iframe.srcdoc = htmlContent;
    toolOutput.appendChild(iframe);
    hideLoader();
}

function displayResult(htmlContent) {
    updateResultDisplay(htmlContent);

    setTimeout(() => {
        mainInterface.style.transition = 'opacity 0.5s, transform 0.5s';
        mainInterface.style.opacity = '0';
        mainInterface.style.transform = 'scale(0.9)';

        setTimeout(() => {
            mainInterface.style.display = 'none';
            resultContainer.classList.add('visible');
        }, 500);
    }, 200);
}

function closeResult() {
    resultContainer.classList.remove('visible');

    setTimeout(() => {
        mainInterface.style.display = 'block';
        setTimeout(() => {
            mainInterface.style.transition = 'opacity 0.5s ease, filter 0.5s ease, transform 0.5s ease';
            mainInterface.style.opacity = '1';
            mainInterface.style.transform = 'scale(1)';
            wishInput.value = '';
            toolOutput.innerHTML = '';
            currentGeneratedHtml = '';
            originalUserWish = '';
        }, 50);
    }, 500);
}

function showRevisionModal() {
    revisionInput.value = '';
    revisionOverlay.classList.add('visible');
    revisionInput.focus();
}

function hideRevisionModal() {
    revisionOverlay.classList.remove('visible');
}

function cleanAIResponse(response) {
    const match = response.match(/```html\s*([\s\S]*?)\s*```|([\s\S]*)/);
    let content = match ? (match[1] || match[2] || '') : '';
    content = content.trim();
    if (content.toLowerCase().startsWith('<!doctype html')) {
        return content;
    }
    return null;
}

// 按鈕漣漪效果
document.querySelectorAll('.wish-button').forEach(button => {
    button.addEventListener('click', function(e) {
        if (this.getElementsByClassName('ripple').length > 0) {
            this.getElementsByClassName('ripple')[0].remove();
        }
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const ripples = document.createElement('span');
        ripples.className = 'ripple';
        ripples.style.left = x + 'px';
        ripples.style.top = y + 'px';

        this.appendChild(ripples);

        setTimeout(() => {
            ripples.remove();
        }, 800);
    });
});

});
</script>
</body>
</html>
